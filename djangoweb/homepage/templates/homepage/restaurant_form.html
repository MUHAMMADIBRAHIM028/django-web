{% extends "homepage/base.html" %}
{% block title %}{{ title|default:"Add / Update Restaurant" }}{% endblock %}

{% block content %}
<div class="container mt-5 d-flex justify-content-center">
  <div class="card shadow-lg p-4" style="max-width: 700px; width: 100%;">
    <h2 class="text-center mb-4">{{ title|default:"Add / Update Restaurant" }}</h2>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Restaurant Name -->
      <div class="mb-3">
        <label for="id_name" class="form-label">Restaurant Name</label>
        <input type="text" name="name" id="id_name" class="form-control"
               value="{{ form.name.value|default_if_none:'' }}" placeholder="Enter Restaurant Name">
      </div>

      <!-- Description -->
      <div class="mb-3">
        <label for="id_description" class="form-label">Description</label>
        <textarea name="description" id="id_description" rows="3" class="form-control"
                  placeholder="Enter description">{{ form.description.value|default_if_none:'' }}</textarea>
      </div>

      <!-- Location Input -->
      <div class="mb-3">
        <label for="id_location" class="form-label">Location</label>
        <input type="text" id="id_location" name="location" class="form-control"
               value="{{ form.location.value|default_if_none:'' }}" placeholder="Search or enter location">
      </div>

      <!-- Map -->
      <div id="map" style="height: 300px; border-radius: 8px;"></div>

      <!-- Submit Buttons -->
      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary px-4">Save</button>
        <a href="{% url 'manage_restaurants' %}" class="btn btn-secondary px-4">Back</a>
      </div>
    </form>
  </div>
</div>

<script>
function initMap() {
  // Try to parse initial location from input, else use default (Lahore)
  let locationInput = document.getElementById("id_location");
  let coords = locationInput.value.split(",");
  let lat = parseFloat(coords[0]);
  let lng = parseFloat(coords[1]);
  const defaultLocation = (!isNaN(lat) && !isNaN(lng)) 
    ? {lat: lat, lng: lng} 
    : {lat: 31.582045, lng: 74.329376};

  // Map
  const map = new google.maps.Map(document.getElementById("map"), {
    center: defaultLocation,
    zoom: 12,
  });

  // Marker
  let marker = new google.maps.Marker({
    position: defaultLocation,
    map: map,
    draggable: true,
  });

  // Places Autocomplete
  const autocomplete = new google.maps.places.Autocomplete(locationInput);
  autocomplete.bindTo("bounds", map);

  autocomplete.addListener("place_changed", function () {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;
    map.setCenter(place.geometry.location);
    map.setZoom(15);
    marker.setPosition(place.geometry.location);
  });

  // Update input when marker dragged
  marker.addListener("dragend", function () {
    locationInput.value =
      marker.getPosition().lat() + "," + marker.getPosition().lng();
  });

  // Update marker when map clicked
  map.addListener("click", function (event) {
    marker.setPosition(event.latLng);
    locationInput.value =
      event.latLng.lat() + "," + event.latLng.lng();
  });
}
</script>

<!-- Google Maps API Key -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCdlxn1ZwrODmbopxCSDi-K-VNPgnbWss&libraries=places&callback=initMap">
</script>
{% endblock %}
